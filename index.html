<!DOCTYPE html>
<html>
   <head>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
      <title>Lua Bytecode File Viewer</title>
      <style>
         html,body{height:100%}
         *{margin:0;padding:0}
      </style>
      <script src="https://github.com/fengari-lua/fengari-web/releases/download/v0.1.4/fengari-web.js" type="text/javascript"></script>
   </head>
   <body>
      <div style="height:50px;background:#efe;display:flex;align-items:center">
         &nbsp; &nbsp;<b>Lua Bytecode File Viewer</b>&nbsp; &nbsp;
         <input type="file" id="FilePicker">
         <button type="button" id="Switch" style="float:right;display:none">.</button>
      </div>
      <textarea style="width:100%;height:calc(100% - 54px);background:#ffe;white-space:pre;resize:none;border:none" id="ViewerOutput" readonly>JavaScript must be enabled</textarea>
      <script type="application/lua">
         local js = require"js"
         local window = js.global
         local document = window.document
         local Switch       = document:getElementById"Switch"
         local FilePicker   = document:getElementById"FilePicker"
         local ViewerOutput = document:getElementById"ViewerOutput"
         ViewerOutput.textContent = 'Fengari has been successfully loaded'
         local ok, bcviewer = pcall(require, "lua-bytecode")
         if ok then

            local listing_is_displayed, listing, decompiled

            local function UpdateOutput(display_listing)
               if display_listing == nil then
                  Switch.style.display = "block"
                  return UpdateOutput(true)
               end
               listing_is_displayed = display_listing
               if display_listing then
                  Switch.textContent = "View Decompiled Source"
                  ViewerOutput.textContent = listing
               else
                  Switch.textContent = "View Bytecode Listing"
                  ViewerOutput.textContent = decompiled
               end
            end

            function Switch.onclick()
               UpdateOutput(not listing_is_displayed)
            end

            function FilePicker.onchange()
               local File = (FilePicker.files or {})[0]
               if File then
                  ViewerOutput.textContent = "Sorry, this web-page is incompatible with your browser.\nTry, for example, FireFox or Chrome.\n"
                  local reader = js.new(window.FileReader)

                  function reader.onloadstart()
                     ViewerOutput.textContent = "Please wait..."
                  end

                  function reader.onerror()
                     local err = reader.error
                     ViewerOutput.textContent = "ERROR: File could not be read!\n"..tostring(err.name).."\n"..tostring(err.message).."\n"
                  end

                  function reader.onload()
                     local pos, utf8_binary_string = 1, reader.result
                     listing, decompiled = bcviewer(
                        function (number_of_bytes)
                           -- This function returns next substring of bytecode
                           local chars, k, c = {}, 0, true
                           while k < number_of_bytes and c do
                              k, c, pos = k+1, utf8_binary_string:match("(.[\x80-\xBF]?)()", pos)
                              chars[k] = c and c:find"^[\xC2\xC3]" and c.char(c:byte()-0xC2<<6|c:byte(-1)) or c
                           end
                           return table.concat(chars)
                        end
                     )
                     UpdateOutput(listing_is_displayed)
                  end

                  reader:readAsBinaryString(File)      -- This invocation is a problem for some browsers
               end
            end

            ViewerOutput.textContent = 'Choose bytecode file'
         else
            ViewerOutput.textContent = 'Failed to load module "lua-bytecode.lua"\n'..tostring(bcviewer)
         end
      </script>
   </body>
</html>
